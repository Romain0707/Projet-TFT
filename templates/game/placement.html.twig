{% extends 'base.html.twig' %}

{% block body %}
<h2>Placement des unités</h2>

<div id="board"></div>

<h3>Team A</h3>
<div id="teamA-units"></div>

<h3>Team B</h3>
<div id="teamB-units"></div>

<button id="startCombat">Lancer le combat</button>


<script>

    let selectedUnit = null;

    const placement = {
        teamA: [],
        teamB: []
    };

    const ZONE_RULES = {
        A: x => x <= 2,
        B: x => x >= 3
    };

    fetch('/game/placement-data')
        .then(res => res.json())
        .then(initPlacement);

    function initPlacement(data) {
        createBoard(data.board.width, data.board.height);
        renderUnits(data.teams.A, 'A');
        renderUnits(data.teams.B, 'B');
    }

    /* ===================== BOARD ===================== */

    function createBoard(w, h) {
        const board = document.getElementById('board');
        board.innerHTML = '';

        for (let y = 0; y < h; y++) {
            for (let x = 0; x < w; x++) {
                const cell = document.createElement('div');
                cell.className = 'cell forbidden';
                cell.dataset.x = x;
                cell.dataset.y = y;
                cell.addEventListener('click', () => placeUnit(cell));
                board.appendChild(cell);
            }
        }
    }

    /* ===================== UNITS ===================== */

    function renderUnits(units, team) {
        const container = document.getElementById(`team${team}-units`);
        container.innerHTML = '';

        units.forEach(unit => {
            const div = document.createElement('div');
            div.className = 'unit';
            div.dataset.id = unit.id;
            div.textContent = `${unit.name} (R:${unit.range})`;
            div.addEventListener('click', () => selectUnit(unit, team, div));
            container.appendChild(div);
        });
    }

    function selectUnit(unit, team, el) {
        if (el.classList.contains('placed')) return;

        document.querySelectorAll('.unit').forEach(u => u.classList.remove('selected'));
        el.classList.add('selected');

        selectedUnit = { ...unit, team };

        highlightZones(team);
    }

    function highlightZones(team) {
        document.querySelectorAll('.cell').forEach(cell => {
            const x = parseInt(cell.dataset.x);
            cell.classList.remove('allowed-A', 'allowed-B');
            cell.classList.add('forbidden');

            if (ZONE_RULES[team](x) && !cell.classList.contains('occupied')) {
                cell.classList.remove('forbidden');
                cell.classList.add(`allowed-${team}`);
            }
        });
    }

    /* ===================== PLACEMENT ===================== */

    function placeUnit(cell) {
        if (!selectedUnit) return;
        if (cell.classList.contains('forbidden')) return;
        if (cell.classList.contains('occupied')) return;

        cell.classList.remove('allowed-A', 'allowed-B');
        cell.classList.add('occupied', selectedUnit.team);
        cell.textContent = selectedUnit.name;

        placement[`team${selectedUnit.team}`].push({
            id: selectedUnit.id,
            team: selectedUnit.team,
            position: {
                x: parseInt(cell.dataset.x),
                y: parseInt(cell.dataset.y)
            }
        });

        markUnitAsPlaced(selectedUnit.id, selectedUnit.team);

        selectedUnit = null;
        clearHighlights();
    }

    function markUnitAsPlaced(id, team) {
        const container = document.getElementById(`team${team}-units`);
        const units = container.querySelectorAll('.unit');

        units.forEach(unit => {
            if (parseInt(unit.dataset.id) === id) {
                unit.classList.remove('selected');
                unit.classList.add('placed');
            }
        });
    }

    function clearHighlights() {
        document.querySelectorAll('.cell').forEach(cell => {
            cell.classList.remove('allowed-A', 'allowed-B');
            cell.classList.add('forbidden');
        });
    }

    /* ===================== SEND TO BACK ===================== */

    document.getElementById('startCombat').addEventListener('click', () => {
        if (placement.teamA.length === 0 || placement.teamB.length === 0) {
            alert('Les deux équipes doivent avoir des unités placées');
            return;
        }

        fetch('/game/placement/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(placement)
        })
        .then(res => res.json())
        .then(data => {
            if (data.redirect) {
                window.location.href = data.redirect;
            }
        })
        .catch(err => console.error(err));
    });

</script>
{% endblock %}